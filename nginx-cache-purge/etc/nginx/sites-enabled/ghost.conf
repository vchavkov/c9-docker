#############################################
# cdn-cache-vhost
#############################################
server {
    server_name                  proxy.minerva.net;

    set $bypass 0;
 
    # security for bypass so localhost can empty cache
    if ($remote_addr ~ "^(127.0.0.1)$") {
        set $bypass $http_secret_header;
    }

    location / {
        proxy_pass               http://ghost-on-heroku.a.assistance.bg;
        proxy_connect_timeout    20s;
        proxy_buffering          on;
        proxy_cache_lock         on;
        proxy_cache              three;
        proxy_cache_key          $request_uri:$http_accept_encoding:$http_accept;
        proxy_cache_valid        200 24h;
        proxy_cache_valid        404 5m;
        proxy_cache_valid        504 1m;
        proxy_cache_use_stale    error timeout invalid_header updating
                                 http_500 http_502 http_503 http_504;
        #proxy_ignore_headers    Cache-Control Set-Cookie;

        # configure proxy-bypass
        proxy_cache_bypass       $bypass;

        # configure proxy-cache-purge
        proxy_cache_purge PURGE from 127.0.0.1;
    }
}